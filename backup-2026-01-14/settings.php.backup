<?php
if (!defined('ABSPATH')) {
    exit;
}

global $wpdb;

// Vérifier que $wpdb est disponible
if (!isset($wpdb) || !$wpdb) {
    echo '<div class="wrap"><div class="notice notice-error"><p>Erreur : Impossible d\'accéder à la base de données.</p></div></div>';
    return;
}

$table = $wpdb->prefix . 'ibs_settings';

// Gérer la déconnexion Google Calendar
if (isset($_POST['ibs_disconnect_google_calendar'])) {
    check_admin_referer('ibs_disconnect_google_calendar_nonce');
    
    try {
        if (defined('IBS_PLUGIN_DIR') && file_exists(IBS_PLUGIN_DIR . 'includes/GoogleCalendar/GoogleCalendar.php')) {
            require_once IBS_PLUGIN_DIR . 'includes/GoogleCalendar/GoogleCalendar.php';
            $google_calendar = new \IBS\GoogleCalendar\GoogleCalendar();
            $google_calendar->disconnect();
            echo '<div class="notice notice-success"><p>Google Calendar déconnecté avec succès.</p></div>';
        }
    } catch (\Exception $e) {
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log("IBS Settings: Error disconnecting Google Calendar - " . $e->getMessage());
        }
        echo '<div class="notice notice-error"><p>Erreur lors de la déconnexion.</p></div>';
    } catch (\Error $e) {
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log("IBS Settings: Fatal error disconnecting Google Calendar - " . $e->getMessage());
        }
        echo '<div class="notice notice-error"><p>Erreur lors de la déconnexion.</p></div>';
    }
}

// Sauvegarder les paramètres
if (isset($_POST['ibs_save_settings'])) {
    check_admin_referer('ibs_save_settings_nonce');
    
    // Vérifier que la table existe
    $table_exists = $wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $table));
    if ($table_exists != $table) {
        echo '<div class="notice notice-error"><p>Erreur : La table des paramètres n\'existe pas. Veuillez réactiver le plugin.</p></div>';
    } else {
        // Réinitialiser les erreurs précédentes
        $wpdb->last_error = '';
        $settings = [
        'min_booking_delay',
        'max_booking_delay',
        'slot_interval',
        'theme_color',
        'theme_secondary_color',
        'show_prices',
        'terms_conditions',
        'confirmation_text',
        'google_calendar_enabled',
        'google_client_id',
        'google_client_secret',
        'email_admin_notification',
        'email_admin_address',
        'email_customer_confirmation',
        'email_customer_reminder',
        'email_reminder_hours',
    ];
    
    foreach ($settings as $key) {
        // Gérer les checkboxes différemment
        if (in_array($key, ['google_calendar_enabled', 'show_prices', 'email_admin_notification', 'email_customer_confirmation', 'email_customer_reminder'])) {
            $value = isset($_POST[$key]) && $_POST[$key] === '1' ? '1' : '0';
        } else {
            // Pour les autres champs, utiliser la fonction de sanitization appropriée
            if (in_array($key, ['terms_conditions', 'confirmation_text'])) {
                $value = isset($_POST[$key]) ? sanitize_textarea_field($_POST[$key]) : '';
            } elseif (in_array($key, ['email_admin_address'])) {
                $value = isset($_POST[$key]) ? sanitize_email($_POST[$key]) : '';
            } else {
                $value = isset($_POST[$key]) ? sanitize_text_field($_POST[$key]) : '';
            }
        }
        
        // Vérifier si le paramètre existe déjà
        $existing = $wpdb->get_var($wpdb->prepare(
            "SELECT id FROM $table WHERE setting_key = %s",
            $key
        ));
        
        if ($existing) {
            // Mettre à jour
            $result = $wpdb->update(
                $table,
                ['setting_value' => $value],
                ['setting_key' => $key],
                ['%s'],
                ['%s']
            );
            
            // Logger pour débogage
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log("IBS Settings: Updating '$key' = '$value'. Result: " . ($result !== false ? 'success' : 'failed'));
                if ($result === false) {
                    error_log("IBS Settings Error: " . $wpdb->last_error);
                }
            }
        } else {
            // Insérer
            $result = $wpdb->insert(
                $table,
                [
                    'setting_key' => $key,
                    'setting_value' => $value
                ],
                ['%s', '%s']
            );
            
            // Logger pour débogage
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log("IBS Settings: Inserting '$key' = '$value'. Result: " . ($result !== false ? 'success (ID: ' . $wpdb->insert_id . ')' : 'failed'));
                if ($result === false) {
                    error_log("IBS Settings Error: " . $wpdb->last_error);
                }
            }
        }
        
        // Si erreur, logger pour débogage
        if ($result === false && $wpdb->last_error) {
            error_log("IBS Settings Error: Failed to save setting '$key' with value '$value'. Error: " . $wpdb->last_error);
        }
    }
    
        // Vérifier s'il y a eu des erreurs
        if ($wpdb->last_error) {
            error_log("IBS Settings: Final error check - " . $wpdb->last_error);
            echo '<div class="notice notice-error"><p>Erreur lors de l\'enregistrement : ' . esc_html($wpdb->last_error) . '</p></div>';
        } else {
            // Logger le succès
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log("IBS Settings: All settings saved successfully. Redirecting...");
            }
            // Rediriger pour éviter la double soumission et afficher les nouvelles valeurs
            wp_redirect(admin_url('admin.php?page=ikomiris-booking-settings&settings_saved=1'));
            exit;
        }
    } // Fin du else (table existe)
} // Fin du if (isset($_POST['ibs_save_settings']))

// Afficher le message de succès après redirection
if (isset($_GET['settings_saved']) && $_GET['settings_saved'] == '1') {
    echo '<div class="notice notice-success is-dismissible"><p>Paramètres enregistrés avec succès.</p></div>';
}

// Afficher les messages de connexion/déconnexion
if (isset($_GET['google_calendar_connected']) && $_GET['google_calendar_connected'] == '1') {
    echo '<div class="notice notice-success"><p>Google Calendar connecté avec succès !</p></div>';
}

if (isset($_GET['google_calendar_error'])) {
    $error = sanitize_text_field($_GET['google_calendar_error']);
    $error_message = __('Erreur lors de la connexion à Google Calendar.', 'ikomiris-booking');
    
    if ($error === 'token_exchange_failed') {
        $error_message = __('Impossible d\'échanger le code d\'autorisation. Vérifiez vos identifiants Client ID et Client Secret.', 'ikomiris-booking');
    }
    
    echo '<div class="notice notice-error"><p>' . esc_html($error_message) . '</p></div>';
}

// Récupérer les paramètres (après toutes les modifications)
$settings = [];
if (isset($wpdb) && $wpdb) {
    $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table'") == $table;
    if ($table_exists) {
        $settings_result = $wpdb->get_results("SELECT setting_key, setting_value FROM $table", OBJECT_K);
        if ($settings_result !== false) {
            $settings = $settings_result;
        }
    }
}

// Fonction pour récupérer un paramètre
function get_setting($key, $default = '') {
    global $wpdb;
    
    if (!isset($wpdb) || !$wpdb) {
        return $default;
    }
    
    // Récupérer directement depuis la base de données pour éviter les problèmes de cache
    $table = $wpdb->prefix . 'ibs_settings';
    
    // Vérifier que la table existe
    $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table'") == $table;
    if (!$table_exists) {
        return $default;
    }
    
    $value = $wpdb->get_var($wpdb->prepare(
        "SELECT setting_value FROM $table WHERE setting_key = %s",
        $key
    ));
    
    // Retourner la valeur ou la valeur par défaut
    return $value !== null ? $value : $default;
}
?>

<div class="wrap">
    <h1>Paramètres du Plugin</h1>
    
    <form method="post" action="<?php echo esc_url(admin_url('admin.php?page=ikomiris-booking-settings')); ?>">
        <?php wp_nonce_field('ibs_save_settings_nonce'); ?>
        
        <h2>Paramètres de réservation</h2>
        <table class="form-table">
            <tr>
                <th scope="row"><label>Délai minimum de réservation (heures)</label></th>
                <td>
                    <input type="number" name="min_booking_delay" value="<?php echo get_setting('min_booking_delay', '2'); ?>" min="0">
                    <p class="description">Les clients ne pourront réserver qu'à partir de X heures dans le futur.</p>
                </td>
            </tr>
            <tr>
                <th scope="row"><label>Délai maximum de réservation (jours)</label></th>
                <td>
                    <input type="number" name="max_booking_delay" value="<?php echo get_setting('max_booking_delay', '90'); ?>" min="1">
                    <p class="description">Les clients pourront réserver jusqu'à X jours à l'avance.</p>
                </td>
            </tr>
            <tr>
                <th scope="row"><label>Intervalle des créneaux (minutes)</label></th>
                <td>
                    <input type="number" name="slot_interval" value="<?php echo get_setting('slot_interval', '10'); ?>" min="5" step="5">
                    <p class="description">Créneaux horaires proposés tous les X minutes (recommandé: 10).</p>
                </td>
            </tr>
        </table>
        
        <h2>Apparence</h2>
        <table class="form-table">
            <tr>
                <th scope="row"><label>Couleur principale</label></th>
                <td>
                    <input type="text" name="theme_color" value="<?php echo get_setting('theme_color', '#0073aa'); ?>" class="ibs-color-picker">
                </td>
            </tr>
            <tr>
                <th scope="row"><label>Afficher les prix</label></th>
                <td>
                    <label>
                        <input type="checkbox" name="show_prices" value="1" <?php checked(get_setting('show_prices', '1'), '1'); ?>>
                        Afficher les prix des services
                    </label>
                </td>
            </tr>
        </table>
        
        <h2>Textes personnalisés</h2>
        <table class="form-table">
            <tr>
                <th scope="row"><label>Conditions générales</label></th>
                <td>
                    <textarea name="terms_conditions" rows="5" class="large-text"><?php echo get_setting('terms_conditions'); ?></textarea>
                </td>
            </tr>
            <tr>
                <th scope="row"><label>Texte de confirmation</label></th>
                <td>
                    <textarea name="confirmation_text" rows="3" class="large-text"><?php echo get_setting('confirmation_text'); ?></textarea>
                </td>
            </tr>
        </table>
        
        <h2>Google Agenda</h2>
        <?php
        $is_connected = false;
        $google_calendar = null;
        
        try {
            if (defined('IBS_PLUGIN_DIR') && file_exists(IBS_PLUGIN_DIR . 'includes/GoogleCalendar/GoogleCalendar.php')) {
                require_once IBS_PLUGIN_DIR . 'includes/GoogleCalendar/GoogleCalendar.php';
                $google_calendar = new \IBS\GoogleCalendar\GoogleCalendar();
                $is_connected = $google_calendar->is_enabled();
            }
        } catch (\Exception $e) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log("IBS Settings: Error loading GoogleCalendar - " . $e->getMessage());
            }
        } catch (\Error $e) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log("IBS Settings: Fatal error loading GoogleCalendar - " . $e->getMessage());
            }
        }
        
        // Récupérer les valeurs directement depuis la base de données pour être sûr
        $client_id = get_setting('google_client_id');
        $client_secret = get_setting('google_client_secret');
        
        // Debug si activé
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log("IBS Settings Display: google_client_id = '" . $client_id . "'");
            error_log("IBS Settings Display: google_client_secret = '" . (empty($client_secret) ? 'EMPTY' : substr($client_secret, 0, 10) . '...') . "'");
        }
        ?>
        <table class="form-table">
            <tr>
                <th scope="row"><label>Activer Google Agenda</label></th>
                <td>
                    <label>
                        <input type="checkbox" name="google_calendar_enabled" value="1" <?php checked(get_setting('google_calendar_enabled'), '1'); ?>>
                        Synchroniser automatiquement les réservations avec Google Agenda
                    </label>
                </td>
            </tr>
            <tr>
                <th scope="row"><label>Client ID</label></th>
                <td>
                    <input type="text" name="google_client_id" value="<?php echo esc_attr($client_id); ?>" class="regular-text">
                    <p class="description">
                        Obtenez votre Client ID depuis le <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a>
                    </p>
                </td>
            </tr>
            <tr>
                <th scope="row"><label>Client Secret</label></th>
                <td>
                    <input type="text" name="google_client_secret" value="<?php echo esc_attr($client_secret); ?>" class="regular-text">
                    <p class="description">
                        Obtenez votre Client Secret depuis le <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a>
                    </p>
                </td>
            </tr>
            <tr>
                <th scope="row"><label>URI de redirection</label></th>
                <td>
                    <input type="text" readonly value="<?php echo esc_attr(admin_url('admin.php?page=ikomiris-booking-settings&action=google_calendar_callback')); ?>" class="regular-text">
                    <p class="description">
                        Copiez cette URL dans les "URI de redirection autorisés" de votre application Google Cloud Console
                    </p>
                </td>
            </tr>
            <tr>
                <th scope="row"><label>Statut de connexion</label></th>
                <td>
                    <?php if ($is_connected): ?>
                        <span style="color: #28a745; font-weight: bold;">✓ Connecté</span>
                        <form method="post" action="" style="display: inline-block; margin-left: 15px;">
                            <?php wp_nonce_field('ibs_disconnect_google_calendar_nonce'); ?>
                            <button type="submit" name="ibs_disconnect_google_calendar" class="button button-secondary" onclick="return confirm('Êtes-vous sûr de vouloir déconnecter Google Calendar ?');">
                                Déconnecter
                            </button>
                        </form>
                    <?php else: ?>
                        <span style="color: #dc3545; font-weight: bold;">✗ Non connecté</span>
                        <?php 
                        if (!empty($client_id) && !empty($client_secret) && $google_calendar) {
                            $auth_url = $google_calendar->get_authorization_url();
                            if (!empty($auth_url)) {
                                echo '<a href="' . esc_url($auth_url) . '" class="button button-primary" style="margin-left: 15px;">Connecter Google Calendar</a>';
                            }
                        } else {
                            echo '<p class="description" style="margin-top: 5px;">Veuillez d\'abord saisir votre Client ID et Client Secret, puis enregistrer les paramètres avant de vous connecter.</p>';
                        }
                        ?>
                    <?php endif; ?>
                </td>
            </tr>
        </table>
        
        <h2>Notifications Email</h2>
        <table class="form-table">
            <tr>
                <th scope="row"><label>Notification admin</label></th>
                <td>
                    <label>
                        <input type="checkbox" name="email_admin_notification" value="1" <?php checked(get_setting('email_admin_notification', '1'), '1'); ?>>
                        Recevoir un email à chaque nouvelle réservation
                    </label>
                </td>
            </tr>
            <tr>
                <th scope="row"><label>Email admin</label></th>
                <td>
                    <input type="email" name="email_admin_address" value="<?php echo get_setting('email_admin_address'); ?>" class="regular-text">
                </td>
            </tr>
            <tr>
                <th scope="row"><label>Confirmation client</label></th>
                <td>
                    <label>
                        <input type="checkbox" name="email_customer_confirmation" value="1" <?php checked(get_setting('email_customer_confirmation', '1'), '1'); ?>>
                        Envoyer un email de confirmation au client
                    </label>
                </td>
            </tr>
            <tr>
                <th scope="row"><label>Rappel client</label></th>
                <td>
                    <label>
                        <input type="checkbox" name="email_customer_reminder" value="1" <?php checked(get_setting('email_customer_reminder', '1'), '1'); ?>>
                        Envoyer un email de rappel au client
                    </label>
                </td>
            </tr>
            <tr>
                <th scope="row"><label>Délai du rappel (heures)</label></th>
                <td>
                    <input type="number" name="email_reminder_hours" value="<?php echo get_setting('email_reminder_hours', '24'); ?>" min="1">
                    <p class="description">Envoyer le rappel X heures avant le rendez-vous.</p>
                </td>
            </tr>
        </table>
        
        <p class="submit">
            <button type="submit" name="ibs_save_settings" class="button button-primary">Enregistrer les paramètres</button>
        </p>
    </form>
</div>

<script>
jQuery(document).ready(function($) {
    $('.ibs-color-picker').wpColorPicker();
});
</script>
