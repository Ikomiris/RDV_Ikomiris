<?php
namespace IBS\API;

if (!defined('ABSPATH')) {
    exit;
}

class BookingAPI {
    
    public function __construct() {
        // Actions AJAX pour les utilisateurs connectés et non connectés
        add_action('wp_ajax_ibs_get_stores', [$this, 'get_stores']);
        add_action('wp_ajax_nopriv_ibs_get_stores', [$this, 'get_stores']);
        
        add_action('wp_ajax_ibs_get_services', [$this, 'get_services']);
        add_action('wp_ajax_nopriv_ibs_get_services', [$this, 'get_services']);
        
        add_action('wp_ajax_ibs_get_available_slots', [$this, 'get_available_slots']);
        add_action('wp_ajax_nopriv_ibs_get_available_slots', [$this, 'get_available_slots']);
        
        add_action('wp_ajax_ibs_create_booking', [$this, 'create_booking']);
        add_action('wp_ajax_nopriv_ibs_create_booking', [$this, 'create_booking']);
        
        add_action('wp_ajax_ibs_cancel_booking', [$this, 'cancel_booking']);
        add_action('wp_ajax_nopriv_ibs_cancel_booking', [$this, 'cancel_booking']);
        
        // Actions AJAX pour l'admin
        add_action('wp_ajax_ibs_admin_save_store', [$this, 'admin_save_store']);
        add_action('wp_ajax_ibs_admin_delete_store', [$this, 'admin_delete_store']);
        add_action('wp_ajax_ibs_admin_save_service', [$this, 'admin_save_service']);
        add_action('wp_ajax_ibs_admin_delete_service', [$this, 'admin_delete_service']);
        add_action('wp_ajax_ibs_admin_save_schedule', [$this, 'admin_save_schedule']);
        add_action('wp_ajax_ibs_admin_delete_schedule', [$this, 'admin_delete_schedule']);
        add_action('wp_ajax_ibs_admin_save_exception', [$this, 'admin_save_exception']);
        add_action('wp_ajax_ibs_admin_delete_exception', [$this, 'admin_delete_exception']);
        add_action('wp_ajax_ibs_admin_update_booking_status', [$this, 'admin_update_booking_status']);
    }
    
    public function get_stores() {
        check_ajax_referer('ibs_frontend_nonce', 'nonce');
        
        global $wpdb;
        $table = $wpdb->prefix . 'ibs_stores';
        
        // Vérifier que la table existe
        $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table'") == $table;
        
        if (!$table_exists) {
            wp_send_json_error(['message' => __('Les tables du plugin ne sont pas créées. Veuillez réactiver le plugin.', 'ikomiris-booking')]);
            return;
        }
        
        $stores = $wpdb->get_results("SELECT * FROM $table WHERE is_active = 1 ORDER BY name ASC");
        
        if ($stores === false) {
            wp_send_json_error(['message' => __('Erreur lors de la récupération des magasins.', 'ikomiris-booking')]);
            return;
        }
        
        wp_send_json_success($stores);
    }
    
    public function get_services() {
        check_ajax_referer('ibs_frontend_nonce', 'nonce');
        
        $store_id = isset($_POST['store_id']) ? intval($_POST['store_id']) : 0;
        
        if (!$store_id) {
            wp_send_json_error(['message' => __('ID du magasin manquant', 'ikomiris-booking')]);
            return;
        }
        
        global $wpdb;
        $table_services = $wpdb->prefix . 'ibs_services';
        $table_store_services = $wpdb->prefix . 'ibs_store_services';
        
        // Vérifier que les tables existent
        $services_table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table_services'") == $table_services;
        $store_services_table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table_store_services'") == $table_store_services;
        
        if (!$services_table_exists || !$store_services_table_exists) {
            wp_send_json_error(['message' => __('Les tables du plugin ne sont pas créées. Veuillez réactiver le plugin.', 'ikomiris-booking')]);
            return;
        }
        
        $services = $wpdb->get_results($wpdb->prepare("
            SELECT s.* 
            FROM $table_services s
            INNER JOIN $table_store_services ss ON s.id = ss.service_id
            WHERE ss.store_id = %d AND s.is_active = 1
            ORDER BY s.display_order ASC, s.name ASC
        ", $store_id));
        
        if ($services === false) {
            wp_send_json_error(['message' => __('Erreur lors de la récupération des services.', 'ikomiris-booking')]);
            return;
        }
        
        wp_send_json_success($services);
    }
    
    public function get_available_slots() {
        check_ajax_referer('ibs_frontend_nonce', 'nonce');
        
        $store_id = isset($_POST['store_id']) ? intval($_POST['store_id']) : 0;
        $service_id = isset($_POST['service_id']) ? intval($_POST['service_id']) : 0;
        $date = isset($_POST['date']) ? sanitize_text_field($_POST['date']) : '';
        
        if (!$store_id || !$service_id || !$date) {
            wp_send_json_error(['message' => __('Paramètres manquants', 'ikomiris-booking')]);
        }
        
        global $wpdb;
        
        // Récupérer la durée du service
        $service = $wpdb->get_row($wpdb->prepare("
            SELECT duration FROM {$wpdb->prefix}ibs_services WHERE id = %d
        ", $service_id));
        
        if (!$service) {
            wp_send_json_error(['message' => __('Service introuvable', 'ikomiris-booking')]);
        }
        
        $duration = intval($service->duration);
        
        // Récupérer les horaires du magasin pour ce jour
        $day_of_week = date('w', strtotime($date)); // 0 = dimanche, 6 = samedi
        
        $schedules = $wpdb->get_results($wpdb->prepare("
            SELECT time_start, time_end 
            FROM {$wpdb->prefix}ibs_schedules 
            WHERE store_id = %d AND day_of_week = %d AND is_active = 1
        ", $store_id, $day_of_week));
        
        if (empty($schedules)) {
            wp_send_json_success([]);
        }
        
        // Vérifier les exceptions
        $exception = $wpdb->get_row($wpdb->prepare("
            SELECT * FROM {$wpdb->prefix}ibs_exceptions 
            WHERE store_id = %d AND exception_date = %s
        ", $store_id, $date));
        
        if ($exception) {
            if ($exception->exception_type === 'closed') {
                wp_send_json_success([]);
            } else {
                // Ouverture exceptionnelle
                $schedules = [(object)[
                    'time_start' => $exception->time_start,
                    'time_end' => $exception->time_end
                ]];
            }
        }
        
        // Récupérer les réservations existantes depuis la base de données
        $table_bookings = $wpdb->prefix . 'ibs_bookings';
        $bookings = [];
        
        // Essayer de récupérer les réservations (gérer l'erreur si la table n'existe pas)
        $bookings_result = $wpdb->get_results($wpdb->prepare("
            SELECT booking_time, duration 
            FROM $table_bookings 
            WHERE store_id = %d AND booking_date = %s AND status IN ('pending', 'confirmed')
        ", $store_id, $date));
        
        if ($bookings_result !== false) {
            $bookings = $bookings_result;
        }
        
        // Récupérer les événements Google Calendar si activé
        try {
            if (file_exists(IBS_PLUGIN_DIR . 'includes/GoogleCalendar/GoogleCalendar.php')) {
                require_once IBS_PLUGIN_DIR . 'includes/GoogleCalendar/GoogleCalendar.php';
                $google_calendar = new \IBS\GoogleCalendar\GoogleCalendar();
                
                if ($google_calendar->is_enabled()) {
                    try {
                        $google_events = $google_calendar->get_events_for_date($date);
                        
                        // Logger pour débogage
                        if (defined('WP_DEBUG') && WP_DEBUG) {
                            error_log("IBS: Found " . count($google_events) . " Google Calendar events for date $date");
                        }
                        
                        // Fusionner avec les réservations de la base de données
                        if (is_array($google_events) && !empty($google_events)) {
                            $bookings = array_merge($bookings, $google_events);
                            
                            if (defined('WP_DEBUG') && WP_DEBUG) {
                                error_log("IBS: Total bookings after merge: " . count($bookings));
                            }
                        }
                    } catch (\Exception $e) {
                        // En cas d'erreur, continuer avec seulement les réservations de la base
                        if (defined('WP_DEBUG') && WP_DEBUG) {
                            error_log('IBS Google Calendar Error: ' . $e->getMessage());
                        }
                    }
                }
            }
        } catch (\Exception $e) {
            // En cas d'erreur lors du chargement de la classe, continuer sans Google Calendar
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('IBS: Error loading GoogleCalendar class - ' . $e->getMessage());
            }
        }
        
        // Générer les créneaux disponibles
        $slots = $this->generate_slots($schedules, $duration, $bookings);
        
        wp_send_json_success($slots);
    }
    
    private function generate_slots($schedules, $duration, $bookings) {
        $slots = [];
        
        foreach ($schedules as $schedule) {
            $start = strtotime($schedule->time_start);
            $end = strtotime($schedule->time_end);
            
            $current = $start;
            
            while ($current + ($duration * 60) <= $end) {
                $slot_time = date('H:i:s', $current);
                $slot_end = date('H:i:s', $current + ($duration * 60));
                
                // Vérifier si le créneau est disponible
                if ($this->is_slot_available($slot_time, $slot_end, $bookings)) {
                    $slots[] = date('H:i', $current);
                }
                
                // Incrémenter de 10 minutes
                $current += 600;
            }
        }
        
        return $slots;
    }
    
    private function is_slot_available($slot_start, $slot_end, $bookings) {
        foreach ($bookings as $booking) {
            // Gérer les objets et les tableaux
            $booking_time = is_object($booking) ? $booking->booking_time : (is_array($booking) ? $booking['booking_time'] : null);
            $booking_duration = is_object($booking) ? $booking->duration : (is_array($booking) ? $booking['duration'] : 60);
            
            if (!$booking_time) {
                continue;
            }
            
            // S'assurer que booking_time est au format H:i:s
            if (strlen($booking_time) == 5) {
                // Format H:i, convertir en H:i:s
                $booking_time .= ':00';
            }
            
            $booking_start = $booking_time;
            $booking_end_time = strtotime($booking_time) + ($booking_duration * 60);
            $booking_end = date('H:i:s', $booking_end_time);
            
            // Vérifier le chevauchement
            if (
                ($slot_start >= $booking_start && $slot_start < $booking_end) ||
                ($slot_end > $booking_start && $slot_end <= $booking_end) ||
                ($slot_start <= $booking_start && $slot_end >= $booking_end)
            ) {
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log("IBS: Slot $slot_start-$slot_end blocked by booking $booking_start-$booking_end (duration: {$booking_duration}min)");
                }
                return false;
            }
        }
        
        return true;
    }
    
    public function create_booking() {
        check_ajax_referer('ibs_frontend_nonce', 'nonce');
        
        global $wpdb;
        
        $store_id = isset($_POST['store_id']) ? intval($_POST['store_id']) : 0;
        $service_id = isset($_POST['service_id']) ? intval($_POST['service_id']) : 0;
        $date = isset($_POST['date']) ? sanitize_text_field($_POST['date']) : '';
        $time = isset($_POST['time']) ? sanitize_text_field($_POST['time']) : '';
        $firstname = isset($_POST['firstname']) ? sanitize_text_field($_POST['firstname']) : '';
        $lastname = isset($_POST['lastname']) ? sanitize_text_field($_POST['lastname']) : '';
        $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
        $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
        $message = isset($_POST['message']) ? sanitize_textarea_field($_POST['message']) : '';
        
        // Validation
        if (!$store_id || !$service_id || !$date || !$time || !$firstname || !$lastname || !$email || !$phone) {
            wp_send_json_error(['message' => __('Tous les champs sont obligatoires', 'ikomiris-booking')]);
        }
        
        if (!is_email($email)) {
            wp_send_json_error(['message' => __('Email invalide', 'ikomiris-booking')]);
        }
        
        // Récupérer la durée du service
        $service = $wpdb->get_row($wpdb->prepare("
            SELECT duration FROM {$wpdb->prefix}ibs_services WHERE id = %d
        ", $service_id));
        
        if (!$service) {
            wp_send_json_error(['message' => __('Service introuvable', 'ikomiris-booking')]);
        }
        
        // Vérifier que la table existe et essayer de la créer si nécessaire
        $table_bookings = $wpdb->prefix . 'ibs_bookings';
        $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table_bookings'") == $table_bookings;
        
        // Si la table n'existe pas, essayer de la créer
        if (!$table_exists) {
            require_once IBS_PLUGIN_DIR . 'includes/Installer.php';
            
            // Essayer de créer uniquement la table bookings
            $charset_collate = $wpdb->get_charset_collate();
            $sql_bookings = "CREATE TABLE IF NOT EXISTS $table_bookings (
                id bigint(20) NOT NULL AUTO_INCREMENT,
                store_id bigint(20) NOT NULL,
                service_id bigint(20) NOT NULL,
                booking_date date NOT NULL,
                booking_time time NOT NULL,
                duration int(11) NOT NULL COMMENT 'Durée en minutes',
                customer_firstname varchar(100) NOT NULL,
                customer_lastname varchar(100) NOT NULL,
                customer_email varchar(100) NOT NULL,
                customer_phone varchar(50) NOT NULL,
                customer_message text,
                status varchar(20) DEFAULT 'pending' COMMENT 'pending, confirmed, cancelled, completed',
                cancel_token varchar(64) UNIQUE,
                google_event_id varchar(255),
                created_at datetime DEFAULT CURRENT_TIMESTAMP,
                updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                PRIMARY KEY (id),
                KEY store_id (store_id),
                KEY service_id (service_id),
                KEY booking_date (booking_date),
                KEY status (status),
                KEY cancel_token (cancel_token)
            ) $charset_collate;";
            
            $wpdb->query($sql_bookings);
            
            // Vérifier à nouveau
            $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table_bookings'") == $table_bookings;
            
            if (!$table_exists) {
                error_log("IBS Error: Table $table_bookings does not exist and could not be created. Last error: " . $wpdb->last_error);
                wp_send_json_error(['message' => __('Erreur : Impossible de créer les tables. Veuillez vérifier les permissions de la base de données ou contacter votre administrateur.', 'ikomiris-booking')]);
            } else {
                error_log("IBS: Table $table_bookings created successfully on-the-fly");
            }
        }
        
        // Générer un token d'annulation unique
        $cancel_token = bin2hex(random_bytes(32));
        
        // Insérer la réservation
        $inserted = $wpdb->insert(
            $table_bookings,
            [
                'store_id' => $store_id,
                'service_id' => $service_id,
                'booking_date' => $date,
                'booking_time' => $time,
                'duration' => $service->duration,
                'customer_firstname' => $firstname,
                'customer_lastname' => $lastname,
                'customer_email' => $email,
                'customer_phone' => $phone,
                'customer_message' => $message,
                'status' => 'confirmed',
                'cancel_token' => $cancel_token,
            ],
            ['%d', '%d', '%s', '%s', '%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s']
        );
        
        if (!$inserted) {
            wp_send_json_error(['message' => __('Erreur lors de la création de la réservation', 'ikomiris-booking')]);
        }
        
        $booking_id = $wpdb->insert_id;
        
        // Synchroniser avec Google Calendar si activé
        $this->sync_booking_to_google_calendar($booking_id, 'create');
        
        // Envoyer les emails de confirmation
        $this->send_confirmation_emails($booking_id);
        
        wp_send_json_success([
            'message' => __('Réservation confirmée !', 'ikomiris-booking'),
            'booking_id' => $booking_id
        ]);
    }
    
    private function send_confirmation_emails($booking_id) {
        // TODO: Implémenter l'envoi d'emails
        // Cela sera fait dans un fichier séparé pour gérer les templates d'emails
    }
    
    public function cancel_booking() {
        check_ajax_referer('ibs_frontend_nonce', 'nonce');
        
        global $wpdb;
        
        $token = isset($_POST['token']) ? sanitize_text_field($_POST['token']) : '';
        
        if (!$token) {
            wp_send_json_error(['message' => __('Token manquant', 'ikomiris-booking')]);
        }
        
        // Récupérer la réservation avant la mise à jour pour avoir l'ID de l'événement Google
        $booking = $wpdb->get_row($wpdb->prepare("SELECT id, google_event_id FROM {$wpdb->prefix}ibs_bookings WHERE cancel_token = %s", $token));
        
        if (!$booking) {
            wp_send_json_error(['message' => __('Réservation introuvable', 'ikomiris-booking')]);
        }
        
        $updated = $wpdb->update(
            $wpdb->prefix . 'ibs_bookings',
            ['status' => 'cancelled'],
            ['cancel_token' => $token],
            ['%s'],
            ['%s']
        );
        
        if (!$updated) {
            wp_send_json_error(['message' => __('Erreur lors de l\'annulation', 'ikomiris-booking')]);
        }
        
        // Synchroniser avec Google Calendar si activé
        $this->sync_booking_to_google_calendar($booking->id, 'delete');
        
        wp_send_json_success(['message' => __('Réservation annulée', 'ikomiris-booking')]);
    }
    
    // Méthodes admin (à compléter)
    public function admin_save_store() {
        check_ajax_referer('ibs_admin_nonce', 'nonce');
        // TODO
    }
    
    public function admin_delete_store() {
        check_ajax_referer('ibs_admin_nonce', 'nonce');
        // TODO
    }
    
    public function admin_save_service() {
        check_ajax_referer('ibs_admin_nonce', 'nonce');
        // TODO
    }
    
    public function admin_delete_service() {
        check_ajax_referer('ibs_admin_nonce', 'nonce');
        // TODO
    }
    
    public function admin_save_schedule() {
        check_ajax_referer('ibs_admin_nonce', 'nonce');
        // TODO
    }
    
    public function admin_delete_schedule() {
        check_ajax_referer('ibs_admin_nonce', 'nonce');
        // TODO
    }
    
    public function admin_save_exception() {
        check_ajax_referer('ibs_admin_nonce', 'nonce');
        // TODO
    }
    
    public function admin_delete_exception() {
        check_ajax_referer('ibs_admin_nonce', 'nonce');
        // TODO
    }
    
    public function admin_update_booking_status() {
        check_ajax_referer('ibs_admin_nonce', 'nonce');
        
        global $wpdb;
        
        $booking_id = isset($_POST['booking_id']) ? intval($_POST['booking_id']) : 0;
        $status = isset($_POST['status']) ? sanitize_text_field($_POST['status']) : '';
        
        if (!$booking_id || !$status) {
            wp_send_json_error(['message' => __('Paramètres manquants', 'ikomiris-booking')]);
        }
        
        $valid_statuses = ['pending', 'confirmed', 'cancelled', 'completed'];
        if (!in_array($status, $valid_statuses)) {
            wp_send_json_error(['message' => __('Statut invalide', 'ikomiris-booking')]);
        }
        
        $updated = $wpdb->update(
            $wpdb->prefix . 'ibs_bookings',
            ['status' => $status],
            ['id' => $booking_id],
            ['%s'],
            ['%d']
        );
        
        if (!$updated) {
            wp_send_json_error(['message' => __('Erreur lors de la mise à jour', 'ikomiris-booking')]);
        }
        
        // Synchroniser avec Google Calendar si activé
        if ($status === 'cancelled') {
            $this->sync_booking_to_google_calendar($booking_id, 'delete');
        } else {
            $this->sync_booking_to_google_calendar($booking_id, 'update');
        }
        
        wp_send_json_success(['message' => __('Statut mis à jour', 'ikomiris-booking')]);
    }
    
    /**
     * Synchronise une réservation avec Google Calendar
     */
    private function sync_booking_to_google_calendar($booking_id, $action = 'create') {
        require_once IBS_PLUGIN_DIR . 'includes/GoogleCalendar/GoogleCalendar.php';
        
        $google_calendar = new \IBS\GoogleCalendar\GoogleCalendar();
        
        if (!$google_calendar->is_enabled()) {
            return;
        }
        
        global $wpdb;
        $table_bookings = $wpdb->prefix . 'ibs_bookings';
        $booking = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_bookings WHERE id = %d", $booking_id));
        
        if (!$booking) {
            return;
        }
        
        try {
            switch ($action) {
                case 'create':
                    if ($booking->status === 'confirmed') {
                        $event_id = $google_calendar->create_event($booking);
                        if ($event_id === false) {
                            error_log("IBS Google Calendar: Failed to create event for booking ID $booking_id");
                        } else {
                            if (defined('WP_DEBUG') && WP_DEBUG) {
                                error_log("IBS Google Calendar: Event created successfully for booking ID $booking_id. Event ID: $event_id");
                            }
                        }
                    }
                    break;
                    
                case 'update':
                    if ($booking->status === 'confirmed') {
                        if (!empty($booking->google_event_id)) {
                            $google_calendar->update_event($booking);
                        } else {
                            $google_calendar->create_event($booking);
                        }
                    } elseif ($booking->status === 'cancelled' && !empty($booking->google_event_id)) {
                        $google_calendar->delete_event($booking->google_event_id);
                        // Supprimer l'ID de l'événement de la base de données
                        $wpdb->update(
                            $wpdb->prefix . 'ibs_bookings',
                            ['google_event_id' => null],
                            ['id' => $booking_id],
                            ['%s'],
                            ['%d']
                        );
                    }
                    break;
                    
                case 'delete':
                    if (!empty($booking->google_event_id)) {
                        $google_calendar->delete_event($booking->google_event_id);
                        // Supprimer l'ID de l'événement de la base de données
                        $wpdb->update(
                            $wpdb->prefix . 'ibs_bookings',
                            ['google_event_id' => null],
                            ['id' => $booking_id],
                            ['%s'],
                            ['%d']
                        );
                    }
                    break;
            }
        } catch (\Exception $e) {
            // Logger l'erreur silencieusement pour ne pas interrompre le processus
            error_log('IBS Google Calendar Sync Error: ' . $e->getMessage());
        }
    }
}
